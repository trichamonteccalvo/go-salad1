<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - FreshGreens</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .cart-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .cart-header {
            margin-bottom: 30px;
        }
        
        .cart-header h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .cart-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }
        
        .cart-items {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 30px;
        }
        
        .cart-item {
            display: flex;
            gap: 20px;
            padding: 20px 0;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .item-image {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .item-description {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .item-customizations {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 10px;
        }
        
        .item-price {
            font-weight: 600;
            color: var(--primary);
        }
        
        .item-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid var(--light-gray);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quantity-btn:hover {
            background: var(--light);
        }
        
        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            padding: 5px;
        }
        
        .remove-btn {
            color: #e53935;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        
        .remove-btn:hover {
            color: #c62828;
        }
        
        .cart-summary {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 30px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .summary-title {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .summary-total {
            font-weight: 600;
            font-size: 1.2rem;
            border-top: 2px solid var(--light-gray);
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .checkout-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            margin-top: 20px;
        }
        
        .empty-cart {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-cart i {
            font-size: 4rem;
            color: var(--light-gray);
            margin-bottom: 20px;
        }
        
        .empty-cart h3 {
            margin-bottom: 10px;
            color: var(--gray);
        }
        
        .empty-cart p {
            color: var(--gray);
            margin-bottom: 30px;
        }
        
        .continue-shopping {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        #gcashInfo input {
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .cart-content {
                grid-template-columns: 1fr;
            }
            
            .cart-item {
                flex-direction: column;
            }
            
            .item-image {
                width: 100%;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <i class="fas fa-leaf"></i>
                    <span>Go Salad</span>
                </div>
                <div class="nav-links">
                    <a href="index.html">Home</a>
                    <a href="index.html#menu">Menu</a>
                    <a href="index.html#builder">Build Your Salad</a>
                    <a href="index.html#nutrition">Nutrition</a>
                    <a href="account.html">My Account</a>
                </div>
                <div class="nav-actions">
                    <a href="cart.html" class="cart-icon">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count">0</span>
                    </a>
                    <button class="btn btn-outline" id="authButton">Sign In</button>
                </div>
            </nav>
        </div>
    </header>

    <div class="container cart-container">
        <div class="cart-header">
            <h1>Your Cart</h1>
            <p>Review your items before checkout</p>
        </div>
        
        <div class="cart-content">
            <div class="cart-items" id="cartItems">
                <!-- Cart items will be loaded here -->
            </div>

            <!-- Debug panel -->
            <div style="margin-top:12px; font-size:0.9rem; color:var(--gray);">
                <button id="debugToggle" class="btn btn-outline" style="margin-bottom:8px;">Toggle Cart Debug</button>
                <div id="cartDebug" style="display:none; background:#fff; padding:12px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.06);">
                    <div style="margin-bottom:8px;"><strong>Current User:</strong> <span id="debugCurrentUser">(loading)</span></div>
                    <div style="margin-bottom:8px;"><strong>Cart for User:</strong></div>
                    <pre id="debugCartJson" style="max-height:240px; overflow:auto; background:#f7f7f7; padding:8px; border-radius:6px;"></pre>
                    <div style="margin-top:8px;"><button id="refreshDebug" class="btn">Refresh Debug</button></div>
                </div>
            </div>
            
            <div class="cart-summary">
                <h3 class="summary-title">Order Summary</h3>
                
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="subtotal">₱0.00</span>
                </div>
                
                <div class="summary-row">
                    <span>Delivery Fee:</span>
                    <span id="deliveryFee">₱50.00</span>
                </div>
                
                <div class="summary-row">
                    <span>Tax:</span>
                    <span id="tax">₱0.00</span>
                </div>

                <div class="summary-row summary-total">
                    <span>Total:</span>
                    <span id="total">₱0.00</span>
                </div>

                <!-- Customer details -->
                <div class="summary-row" style="flex-direction:column; gap:6px;">
                    <label for="customerNameInput">Full Name:</label>
                    <input type="text" id="customerNameInput" placeholder="Complete name" style="width:100%; padding:8px;">
                </div>

                <div class="summary-row" style="flex-direction:column; gap:6px; margin-top:8px;">
                    <label for="customerPhoneInput">Phone Number:</label>
                    <input type="text" id="customerPhoneInput" placeholder="09XXXXXXXXX" style="width:100%; padding:8px;">
                </div>

                <div class="summary-row" style="flex-direction:column; gap:6px; margin-top:8px;">
                    <label for="customerAddressInput">Delivery Address:</label>
                    <input type="text" id="customerAddressInput" placeholder="House / Street / Barangay / City" style="width:100%; padding:8px;">
                </div>

                <div class="summary-row" style="flex-direction:column; gap:6px; margin-top:8px;">
                    <label for="orderMessageInput">Optional Message (e.g., delivery notes):</label>
                    <textarea id="orderMessageInput" placeholder="Any notes for the kitchen or delivery" style="width:100%; padding:8px; height:60px;"></textarea>
                </div>

                <!-- Payment method -->
                <div class="summary-row" style="margin-top:8px;">
                    <label for="paymentMethod">Payment Method:</label>
                    <select id="paymentMethod">
                        <option value="cash">Cash on Delivery</option>
                        <option value="gcash">GCash</option>
                    </select>
                </div>

                <div id="gcashInfo" style="display:none; margin-top:10px;">
                    <label for="gcashNumber">GCash Number:</label>
                    <input type="text" id="gcashNumber" placeholder="09XXXXXXXXX" style="width:100%; padding:8px; margin-top:5px;">
                </div>

                <button class="btn btn-primary checkout-btn" id="checkoutBtn" disabled>
                    Proceed to Checkout
                </button>
                
                <div class="continue-shopping">
                    <a href="index.html">
                        <i class="fas fa-arrow-left"></i>
                        Continue Shopping
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="database.js"></script>
    <script src="cart.js"></script>
    <script>
        // Cart page functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Debug: Log localStorage content
            console.log('[Cart] localStorage carts:', localStorage.getItem('freshgreens_carts'));
            console.log('[Cart] current user:', localStorage.getItem('freshgreens_current_user'));
            
            loadCartItems();
            setupEventListeners();
            
            // Setup debug panel
            setupDebugPanel();
        });

        function setupDebugPanel() {
            const debugToggle = document.getElementById('debugToggle');
            const cartDebug = document.getElementById('cartDebug');
            const refreshDebug = document.getElementById('refreshDebug');
            
            if (debugToggle) {
                debugToggle.addEventListener('click', function() {
                    cartDebug.style.display = cartDebug.style.display === 'none' ? 'block' : 'none';
                });
            }
            
            if (refreshDebug) {
                refreshDebug.addEventListener('click', function() {
                    updateDebugInfo();
                });
            }
            
            updateDebugInfo();
        }

        function updateDebugInfo() {
            const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user') || 'null');
            const userId = currentUser ? currentUser.id : 'guest';
            const carts = JSON.parse(localStorage.getItem('freshgreens_carts') || '{}');
            const userCart = carts[userId] || { items: [], total: 0 };
            
            document.getElementById('debugCurrentUser').textContent = currentUser ? `${currentUser.firstName} (${userId})` : 'Guest (guest)';
            document.getElementById('debugCartJson').textContent = JSON.stringify(userCart, null, 2);
        }

        function loadCartItems() {
            const cartItemsContainer = document.getElementById('cartItems');
            const cart = freshGreensDB.getCart(getUserId());
            console.log('[Cart Page] loadCartItems userId=', getUserId(), 'cart=', cart);

            if (cart.items.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Your cart is empty</h3>
                        <p>Add some delicious salads to get started!</p>
                        <a href="index.html" class="btn btn-primary">
                            <i class="fas fa-utensils"></i>
                            Browse Menu
                        </a>
                    </div>
                `;
                updateSummary(0);
                return;
            }

            // Separate items by type
            const premadeItems = cart.items.filter(item => item.product.category === 'premade');
            const customItems = cart.items.filter(item => item.product.category === 'custom');

            let itemsHTML = '';

            if (premadeItems.length > 0) {
                itemsHTML += `<h3 style="margin-bottom:10px;color:var(--primary)">Premade Salads</h3>`;
                premadeItems.forEach(item => {
                    const itemTotal = item.product.price * item.quantity;
                    itemsHTML += `
                        <div class="cart-item" data-item-id="${item.id}">
                            <div class="item-image" style="background-image: url('${item.product.image || 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?ixlib=rb-4.0.3&auto=format&fit=crop&w=1770&q=80'}')"></div>
                            <div class="item-details">
                                <div class="item-name">${item.product.name}</div>
                                <div class="item-description">${item.product.description || ''}</div>
                                <div class="item-price">₱${itemTotal.toFixed(2)}</div>
                            </div>
                            <div class="item-actions">
                                <div class="quantity-controls">
                                    <button class="quantity-btn decrease-btn" onclick="updateQuantity('${item.id}', ${item.quantity - 1})">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="quantity-input" value="${item.quantity}" min="1" 
                                           onchange="updateQuantity('${item.id}', parseInt(this.value))">
                                    <button class="quantity-btn increase-btn" onclick="updateQuantity('${item.id}', ${item.quantity + 1})">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <button class="remove-btn" onclick="removeItem('${item.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            if (customItems.length > 0) {
                itemsHTML += `<h3 style="margin:30px 0 10px 0;color:var(--primary)">Custom Salads</h3>`;
                customItems.forEach(item => {
                    const itemTotal = item.product.price * item.quantity;
                    itemsHTML += `
                        <div class="cart-item" data-item-id="${item.id}">
                            <div class="item-image" style="background-image: url('${item.product.image || 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?ixlib=rb-4.0.3&auto=format&fit=crop&w=1770&q=80'}')"></div>
                            <div class="item-details">
                                <div class="item-name">${item.product.name}</div>
                                <div class="item-description">${item.product.description || 'Custom salad'}</div>
                                ${item.customizations && Object.keys(item.customizations).length > 0 ? `
                                    <div class="item-customizations">
                                        ${getCustomizationsText(item.customizations)}
                                    </div>
                                ` : ''}
                                <div class="item-price">₱${itemTotal.toFixed(2)}</div>
                            </div>
                            <div class="item-actions">
                                <div class="quantity-controls">
                                    <button class="quantity-btn decrease-btn" onclick="updateQuantity('${item.id}', ${item.quantity - 1})">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="quantity-input" value="${item.quantity}" min="1" 
                                           onchange="updateQuantity('${item.id}', parseInt(this.value))">
                                    <button class="quantity-btn increase-btn" onclick="updateQuantity('${item.id}', ${item.quantity + 1})">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <button class="remove-btn" onclick="removeItem('${item.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            cartItemsContainer.innerHTML = itemsHTML;
            updateSummary(cart.total);
        }

        function getCustomizationsText(customizations) {
            let text = '';
            
            // Handle both old format (single values) and new format (arrays)
            if (customizations.bases && customizations.bases.length > 0) {
                text += `Bases: ${customizations.bases.map(b => b.name).join(', ')}, `;
            } else if (customizations.base) {
                text += `Base: ${customizations.base.name}, `;
            }
            
            if (customizations.proteins && customizations.proteins.length > 0) {
                text += `Proteins: ${customizations.proteins.map(p => p.name).join(', ')}, `;
            } else if (customizations.protein) {
                text += `Protein: ${customizations.protein.name}, `;
            }
            
            if (customizations.vegetables && customizations.vegetables.length > 0) {
                text += `Veggies: ${customizations.vegetables.map(v => v.name).join(', ')}, `;
            }
            
            if (customizations.fruits && customizations.fruits.length > 0) {
                text += `Fruits: ${customizations.fruits.map(f => f.name).join(', ')}, `;
            }
            
            if (customizations.toppings && customizations.toppings.length > 0) {
                text += `Toppings: ${customizations.toppings.map(t => t.name).join(', ')}, `;
            }
            
            if (customizations.dressings && customizations.dressings.length > 0) {
                text += `Dressings: ${customizations.dressings.map(d => d.name).join(', ')}, `;
            } else if (customizations.dressing) {
                text += `Dressing: ${customizations.dressing.name}`;
            }
            
            return text.replace(/, $/, '');
        }

        function updateSummary(subtotal) {
            const deliveryFee = 50;
            const tax = subtotal * 0.12;
            const total = subtotal + deliveryFee + tax;

            document.getElementById('subtotal').textContent = `₱${subtotal.toFixed(2)}`;
            document.getElementById('deliveryFee').textContent = `₱${deliveryFee.toFixed(2)}`;
            document.getElementById('tax').textContent = `₱${tax.toFixed(2)}`;
            document.getElementById('total').textContent = `₱${total.toFixed(2)}`;

            const checkoutBtn = document.getElementById('checkoutBtn');
            checkoutBtn.disabled = subtotal === 0;
        }

        function updateQuantity(itemId, newQuantity) {
            if (newQuantity < 1) return;
            const cart = freshGreensDB.updateCartItem(getUserId(), itemId, newQuantity);
            if (cart) {
                loadCartItems();
                updateCartCount();
            }
        }

        function removeItem(itemId) {
            const cart = freshGreensDB.removeFromCart(getUserId(), itemId);
            if (cart) {
                loadCartItems();
                updateCartCount();
            }
        }

        function updateCartCount() {
            const count = freshGreensDB.getCartItemCount(getUserId());
            document.querySelectorAll('.cart-count').forEach(el => el.textContent = count);
        }

        function getUserId() {
            const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
            return currentUser ? currentUser.id : 'guest';
        }

        function setupEventListeners() {
            // Checkout
            document.getElementById('checkoutBtn').addEventListener('click', function() {
                const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                if (!currentUser) {
                    alert('Please sign in to checkout');
                    window.location.href = 'login.html';
                    return;
                }
                proceedToCheckout();
            });

            // Auth button
            const authButton = document.getElementById('authButton');
            const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
            if (currentUser) {
                authButton.textContent = 'My Account';
                authButton.onclick = () => window.location.href = 'account.html';
            } else {
                authButton.textContent = 'Sign In';
                authButton.onclick = () => window.location.href = 'login.html';
            }

            // Payment method select
            const paymentSelect = document.getElementById('paymentMethod');
            const gcashInfo = document.getElementById('gcashInfo');

            paymentSelect.addEventListener('change', function() {
                if (this.value === 'gcash') {
                    gcashInfo.style.display = 'block';
                } else {
                    gcashInfo.style.display = 'none';
                }
            });

            // Prefill customer details if logged in
            // reuse `currentUser` declared above
            if (currentUser) {
                const nameEl = document.getElementById('customerNameInput');
                const phoneEl = document.getElementById('customerPhoneInput');
                const addrEl = document.getElementById('customerAddressInput');
                if (nameEl) nameEl.value = `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim();
                if (phoneEl) phoneEl.value = currentUser.phone || '';
                if (addrEl) {
                    if (currentUser.addresses && currentUser.addresses.length > 0) {
                        addrEl.value = currentUser.addresses[0].address || '';
                    } else if (currentUser.address) {
                        addrEl.value = currentUser.address || '';
                    }
                }
            }
        }
        
        function proceedToCheckout() {
            const cart = freshGreensDB.getCart(getUserId());
            const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
            if (cart.items.length === 0) {
                alert('Your cart is empty');
                return;
            }

            let subtotal = 0;
            cart.items.forEach(item => subtotal += (item.product.price || 0) * item.quantity);

            const deliveryFee = 50;
            const tax = subtotal * 0.12;
            const total = subtotal + deliveryFee + tax;

            // Payment method
            const selectedPaymentMethod = document.getElementById('paymentMethod').value;
            let paymentDetails = {};

            if (selectedPaymentMethod === 'gcash') {
                const gcashNumber = document.getElementById('gcashNumber').value.trim();
                if (!gcashNumber || !/^09\d{9}$/.test(gcashNumber)) {
                    alert('Please enter a valid GCash number (09XXXXXXXXX).');
                    return;
                }
                paymentDetails = { method: 'gcash', number: gcashNumber };
            } else {
                paymentDetails = { method: 'cash' };
            }

            // Customer-provided details (allow overriding user's saved info)
            const customerName = document.getElementById('customerNameInput').value.trim();
            const customerPhone = document.getElementById('customerPhoneInput').value.trim();
            const customerAddress = document.getElementById('customerAddressInput').value.trim();
            const orderMessage = document.getElementById('orderMessageInput').value.trim();

            // Basic validation
            if (!customerName) {
                alert('Please enter your full name.');
                return;
            }
            if (!customerPhone || !/^09\d{9}$/.test(customerPhone)) {
                alert('Please enter a valid phone number (09XXXXXXXXX).');
                return;
            }
            if (!customerAddress) {
                alert('Please enter a delivery address.');
                return;
            }

            const order = freshGreensDB.createOrder({
                customerName: customerName,
                email: currentUser ? currentUser.email : '',
                phone: customerPhone,
                items: cart.items,
                total: total,
                paymentMethod: paymentDetails.method,
                paymentDetails: paymentDetails,
                deliveryAddress: customerAddress,
                notes: orderMessage,
                userId: currentUser ? currentUser.id : null
            });

            if (order) {
                freshGreensDB.clearCart(getUserId());
                alert(`Order placed successfully! Order ID: ${order.id}`);
                window.location.href = 'account.html';
            } else {
                alert('There was an error placing your order. Please try again.');
            }
        }
    </script>
</body>
</html>
