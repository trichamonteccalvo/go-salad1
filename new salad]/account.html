<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - FreshGreens</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .account-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .account-welcome h1 {
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .account-welcome p {
            color: var(--gray);
        }
        
        .account-nav {
            display: flex;
            gap: 15px;
        }
        
        .account-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }
        
        .account-sidebar {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 0;
            overflow: hidden;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            border-bottom: 1px solid var(--light-gray);
        }
        
        .sidebar-menu li:last-child {
            border-bottom: none;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: var(--primary-light);
            color: white;
        }
        
        .sidebar-menu i {
            width: 20px;
            text-align: center;
        }
        
        .account-main {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 30px;
        }
        
        .section-title {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .section-title h2 {
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .profile-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-card {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
        }
        
        .info-card h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .info-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 500;
        }
        
        .info-value {
            color: var(--gray);
        }
        
        .edit-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .edit-btn:hover {
            background: var(--primary-dark);
        }
        
        .preferences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .preference-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .order-history {
            margin-top: 30px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .order-details h4 {
            margin-bottom: 5px;
        }
        
        .order-date {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .order-price {
            font-weight: 600;
            color: var(--primary);
        }
        
        .no-orders {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .no-orders i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--light-gray);
        }
        
        @media (max-width: 768px) {
            .account-content {
                grid-template-columns: 1fr;
            }
            
            .profile-info {
                grid-template-columns: 1fr;
            }
            
            .account-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }

        /* Buttons used across account page */
        .btn {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid transparent;
            background: #f5f5f5;
            color: #222;
            cursor: pointer;
            transition: background 0.15s ease, transform 0.06s ease;
            font-weight: 600;
        }

        .btn:hover { transform: translateY(-1px); }

        .btn-primary {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary-dark);
        }

        .btn-outline {
            background: transparent;
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Card improvements for addresses & payments */
        .info-card { background: #fff; border: 1px solid rgba(0,0,0,0.05); }
        .info-card .btn { padding: 6px 10px; font-size: 0.9rem; }

        .no-orders { background: linear-gradient(90deg, rgba(246,248,250,0.6), rgba(255,255,255,0.6)); border-radius: 8px; padding: 30px; }

        /* Payment method badges */
        .payment-badge { display:inline-block; padding:4px 8px; border-radius:12px; font-size:0.8rem; background:#f1f6f2; color:var(--primary); margin-left:8px; }

        /* Modal scaffold (hidden by default) - ready for future UX improvements */
        .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:1200; }
        .modal { background:#fff; border-radius:10px; width:100%; max-width:520px; padding:20px; box-shadow:0 20px 50px rgba(0,0,0,0.2); }
        .modal h3 { margin-top:0; }
        .modal .form-row { display:flex; gap:10px; }
        .modal .form-input { width:100%; padding:10px; border:1px solid #e6e6e6; border-radius:6px; }
        .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:15px; }

    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <i class="fas fa-leaf"></i>
                    <span>Go Salad</span>
                </div>
                <div class="nav-links">
                    <a href="index.html">Home</a>
                    <a href="index.html#menu">Menu</a>
                    <a href="index.html#builder">Build Your Salad</a>
                    <a href="index.html#nutrition">Nutrition</a>
                    <a href="account.html" class="active">My Account</a>
                </div>
                <div class="nav-actions">
                    <a href="#" class="cart-icon">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count">0</span>
                    </a>
                    <button class="btn btn-outline" id="logoutBtn">Logout</button>
                </div>
            </nav>
        </div>
    </header>

    <div class="container account-container">
        <div class="account-header">
            <div class="account-welcome">
                <h1 id="welcomeMessage">Welcome, User!</h1>
                <p id="memberSince">Member since January 2023</p>
            </div>
            <div class="account-nav">
                <button class="btn btn-primary" onclick="window.location.href='index.html#builder'">
                    <i class="fas fa-plus"></i> Build New Salad
                </button>
                <button class="btn btn-outline" onclick="window.location.href='index.html#menu'">
                    <i class="fas fa-utensils"></i> Browse Menu
                </button>
            </div>
        </div>
        
        <div class="account-content">
            <div class="account-sidebar">
                <ul class="sidebar-menu">
                    <li><a href="#" class="active" data-tab="profile"><i class="fas fa-user"></i> Profile</a></li>
                    <li><a href="#" data-tab="preferences"><i class="fas fa-heart"></i> Preferences</a></li>
                    <li><a href="#" data-tab="orders"><i class="fas fa-history"></i> Order History</a></li>
                    <li><a href="#" data-tab="addresses"><i class="fas fa-map-marker-alt"></i> Addresses</a></li>
                    <li><a href="#" data-tab="payment"><i class="fas fa-credit-card"></i> Payment Methods</a></li>
                    <li><a href="track-order.html"><i class="fas fa-tracking"></i> Track Order</a></li>
                </ul>
            </div>
            
            <div class="account-main">
                <!-- Profile Tab -->
                <div class="account-tab active" id="profile-tab">
                    <div class="section-title">
                        <h2>Personal Information</h2>
                    </div>
                    
                    <div class="profile-info">
                        <div class="info-card">
                            <h3>Basic Info</h3>
                            <div class="info-item">
                                <span class="info-label">Full Name:</span>
                                <span class="info-value" id="userFullName">Loading...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Email:</span>
                                <span class="info-value" id="userEmail">Loading...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Member Since:</span>
                                <span class="info-value" id="userJoinDate">Loading...</span>
                            </div>
                            <button class="edit-btn" id="editProfileBtn">Edit Profile</button>
                        </div>
                        
                        <div class="info-card">
                            <h3>Dietary Preferences</h3>
                            <div class="info-item">
                                <span class="info-label">Primary Diet:</span>
                                <span class="info-value" id="userDiet">Not specified</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Allergies:</span>
                                <span class="info-value" id="userAllergies">None specified</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Favorite Ingredients:</span>
                                <span class="info-value" id="userFavorites">Not specified</span>
                            </div>
                            <button class="edit-btn" id="editPreferencesBtn">Edit Preferences</button>
                        </div>
                    </div>
                </div>
                
                <!-- Preferences Tab -->
                <div class="account-tab" id="preferences-tab">
                    <div class="section-title">
                        <h2>Dietary Preferences</h2>
                    </div>
                    
                    <h3>Select your dietary preferences:</h3>
                    <div class="preferences-grid">
                        <div class="preference-item">
                            <input type="checkbox" id="pref-vegan" class="diet-preference">
                            <label for="pref-vegan">Vegan</label>
                        </div>
                        <div class="preference-item">
                            <input type="checkbox" id="pref-vegetarian" class="diet-preference">
                            <label for="pref-vegetarian">Vegetarian</label>
                        </div>
                        <div class="preference-item">
                            <input type="checkbox" id="pref-glutenfree" class="diet-preference">
                            <label for="pref-glutenfree">Gluten-Free</label>
                        </div>
                        <div class="preference-item">
                            <input type="checkbox" id="pref-dairyfree" class="diet-preference">
                            <label for="pref-dairyfree">Dairy-Free</label>
                        </div>
                        <div class="preference-item">
                            <input type="checkbox" id="pref-lowcarb" class="diet-preference">
                            <label for="pref-lowcarb">Low-Carb</label>
                        </div>
                        <div class="preference-item">
                            <input type="checkbox" id="pref-highprotein" class="diet-preference">
                            <label for="pref-highprotein">High-Protein</label>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="savePreferencesBtn">Save Preferences</button>
                </div>
                
                <!-- Order History Tab -->
                <div class="account-tab" id="orders-tab">
                    <div class="section-title">
                        <h2>Order History</h2>
                    </div>
                    
                    <div id="orderHistoryContent">
                        <div class="no-orders">
                            <i class="fas fa-shopping-bag"></i>
                            <h3>No orders yet</h3>
                            <p>Your order history will appear here once you place your first order.</p>
                            <button class="btn btn-primary" onclick="window.location.href='index.html#menu'">Browse Menu</button>
                        </div>
                    </div>
                </div>
                
                <!-- Addresses Tab -->
                <div class="account-tab" id="addresses-tab">
                    <div class="section-title">
                        <h2>Saved Addresses</h2>
                    </div>
                    
                    <div class="no-orders">
                        <i class="fas fa-map-marker-alt"></i>
                        <h3>No saved addresses</h3>
                        <p>You haven't saved any delivery addresses yet.</p>
                        <button class="btn btn-primary" id="addAddressBtn">Add Address</button>
                    </div>
                </div>
                
                <!-- Payment Methods Tab -->
                <div class="account-tab" id="payment-tab">
                    <div class="section-title">
                        <h2>Payment Methods</h2>
                    </div>
                    
                    <div class="no-orders">
                        <i class="fas fa-credit-card"></i>
                        <h3>No payment methods</h3>
                        <p>You haven't saved any payment methods yet.</p>
                        <button class="btn btn-primary" id="addPaymentBtn">Add Payment Method</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in
        window.addEventListener('DOMContentLoaded', function() {
            const currentUser = localStorage.getItem('freshgreens_current_user');
            
            if (!currentUser) {
                // Redirect to login if not logged in
                window.location.href = 'login.html';
                return;
            }
            
            // Load user data
            const user = JSON.parse(currentUser);
            loadUserData(user);
            setupEventListeners();
        });
        
        function loadUserData(user) {
            // Update welcome message
            document.getElementById('welcomeMessage').textContent = `Welcome, ${user.firstName}!`;
            
            // Format join date
            const joinDate = new Date(user.joinDate);
            const options = { year: 'numeric', month: 'long' };
            document.getElementById('memberSince').textContent = `Member since ${joinDate.toLocaleDateString('en-US', options)}`;
            
            // Update profile info
            document.getElementById('userFullName').textContent = `${user.firstName} ${user.lastName}`;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userJoinDate').textContent = joinDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Load preferences if they exist
            if (user.preferences && user.preferences.dietary) {
                user.preferences.dietary.forEach(pref => {
                    const checkbox = document.getElementById(`pref-${pref.toLowerCase()}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                
                // Update profile view
                if (user.preferences.dietary.length > 0) {
                    // Use the label text for each saved preference (falls back to capitalized key)
                    const displayPrefs = user.preferences.dietary.map(prefKey => {
                        const normalized = prefKey.toLowerCase();
                        const labelEl = document.querySelector(`label[for="pref-${normalized}"]`);
                        if (labelEl) return labelEl.textContent.trim();
                        // Fallback: transform 'highprotein' -> 'Highprotein'
                        return prefKey.charAt(0).toUpperCase() + prefKey.slice(1);
                    });

                    document.getElementById('userDiet').textContent = displayPrefs.join(', ');
                }
                
                if (user.preferences.allergies && user.preferences.allergies.length > 0) {
                    document.getElementById('userAllergies').textContent = user.preferences.allergies.join(', ');
                }
                
                if (user.preferences.favorites && user.preferences.favorites.length > 0) {
                    document.getElementById('userFavorites').textContent = user.preferences.favorites.join(', ');
                }
            }
            
            // Load order history if it exists
            if (user.orderHistory && user.orderHistory.length > 0) {
                displayOrderHistory(user.orderHistory);
            }
            // Render addresses section
            renderAddresses(user);
            // Render payment methods
            renderPayments(user);
        }
        
        function displayOrderHistory(orders) {
            const orderHistoryContent = document.getElementById('orderHistoryContent');
            
            if (orders.length === 0) {
                orderHistoryContent.innerHTML = `
                    <div class="no-orders">
                        <i class="fas fa-shopping-bag"></i>
                        <h3>No orders yet</h3>
                        <p>Your order history will appear here once you place your first order.</p>
                        <button class="btn btn-primary" onclick="window.location.href='index.html#menu'">Browse Menu</button>
                    </div>
                `;
                return;
            }
            
            let ordersHTML = '';
            
            orders.forEach(order => {
                const orderDate = new Date(order.date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                ordersHTML += `
                    <div class="order-item">
                        <div class="order-details">
                            <h4>${order.items.join(', ')}</h4>
                            <p class="order-date">Ordered on ${orderDate}</p>
                        </div>
                        <div class="order-price">₱${order.total.toFixed(2)}</div>
                    </div>
                `;
            });
            
            orderHistoryContent.innerHTML = ordersHTML;
        }
        
        function setupEventListeners() {
            // Tab navigation — only intercept links that have a data-tab attribute
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function(e) {
                    const tabName = this.getAttribute('data-tab');
                    if (!tabName) {
                        // No data-tab -> external or page link (e.g., Track Order). Allow default navigation.
                        return;
                    }
                    e.preventDefault();

                    // Remove active class from all tabs and links
                    document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
                    document.querySelectorAll('.account-tab').forEach(tab => tab.classList.remove('active'));

                    // Add active class to clicked link
                    this.classList.add('active');

                    // Show corresponding tab
                    const tabId = tabName + '-tab';
                    const target = document.getElementById(tabId);
                    if (target) target.classList.add('active');
                });
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('freshgreens_current_user');
                window.location.href = 'login.html';
            });
            
            // Save preferences
            document.getElementById('savePreferencesBtn').addEventListener('click', function() {
                const selectedPreferences = [];
                document.querySelectorAll('.diet-preference:checked').forEach(checkbox => {
                    selectedPreferences.push(checkbox.id.replace('pref-', ''));
                });
                
                // Update user preferences
                const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                currentUser.preferences.dietary = selectedPreferences;
                
                // Update in localStorage
                localStorage.setItem('freshgreens_current_user', JSON.stringify(currentUser));
                
                // Update users array
                const users = JSON.parse(localStorage.getItem('freshgreens_users')) || [];
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('freshgreens_users', JSON.stringify(users));
                }
                
                alert('Preferences saved successfully!');
            });
            
            // Add sample order (for demo purposes)
            document.querySelector('.btn-primary').addEventListener('click', function() {
                if (this.textContent.includes('Browse Menu')) {
                    // Add a sample order when user goes to browse menu
                    const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                    
                    if (!currentUser.orderHistory) {
                        currentUser.orderHistory = [];
                    }
                    
                    // Add sample order if none exists
                    if (currentUser.orderHistory.length === 0) {
                        currentUser.orderHistory.push({
                            id: 'ORD' + Date.now(),
                            date: new Date().toISOString(),
                            items: ['Mediterranean Bliss', 'Custom Salad'],
                            total: 388,
                            status: 'Delivered'
                        });
                        
                        // Update in localStorage
                        localStorage.setItem('freshgreens_current_user', JSON.stringify(currentUser));
                        
                        const users = JSON.parse(localStorage.getItem('freshgreens_users')) || [];
                        const userIndex = users.findIndex(u => u.id === currentUser.id);
                        if (userIndex !== -1) {
                            users[userIndex] = currentUser;
                            localStorage.setItem('freshgreens_users', JSON.stringify(users));
                        }
                    }
                }
            });
            
            // Addresses: Add / render
            const addAddressBtn = document.getElementById('addAddressBtn');
            if (addAddressBtn) {
                addAddressBtn.addEventListener('click', function() {
                    const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                    showAddressPrompt(currentUser);
                });
            }
            // Payments: Add / render
            const addPaymentBtn = document.getElementById('addPaymentBtn');
            if (addPaymentBtn) {
                addPaymentBtn.addEventListener('click', function() {
                    const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                    showPaymentPrompt(currentUser);
                });
            }
        }

        // Render addresses for the user
        function renderAddresses(user) {
            const addressesTab = document.getElementById('addresses-tab');
            if (!addressesTab) return;

            const addresses = (user.addresses && user.addresses.length) ? user.addresses : [];

            if (addresses.length === 0) {
                addressesTab.innerHTML = `
                    <div class="section-title">
                        <h2>Saved Addresses</h2>
                    </div>
                    <div class="no-orders">
                        <i class="fas fa-map-marker-alt"></i>
                        <h3>No saved addresses</h3>
                        <p>You haven't saved any delivery addresses yet.</p>
                        <button class="btn btn-primary" id="addAddressBtn">Add Address</button>
                    </div>
                `;
                // Reattach handler
                const addBtn = document.getElementById('addAddressBtn');
                if (addBtn) addBtn.addEventListener('click', function() {
                    const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                    showAddressPrompt(currentUser);
                });
                return;
            }

            // Build addresses list
            let html = '<div class="section-title"><h2>Saved Addresses</h2></div><div style="display:grid;gap:10px;">';
            addresses.forEach(addr => {
                html += `
                    <div class="info-card" style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:600">${addr.label || 'Home'}</div>
                            <div style="color:var(--gray)">${addr.address}</div>
                        </div>
                        <div style="display:flex;gap:8px">
                            <button class="edit-address-btn btn" data-id="${addr.id}">Edit</button>
                            <button class="remove-address-btn btn" data-id="${addr.id}">Remove</button>
                        </div>
                    </div>
                `;
            });
            html += `<div><button class="btn btn-primary" id="addAddressBtn">Add Address</button></div>`;
            html += '</div>';

            addressesTab.innerHTML = html;

            // Wire buttons
            document.querySelectorAll('.edit-address-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                    const addr = (currentUser.addresses || []).find(a => a.id === id);
                    if (addr) showAddressPrompt(currentUser, addr);
                });
            });

            document.querySelectorAll('.remove-address-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    if (!confirm('Remove this address?')) return;
                    const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                    currentUser.addresses = (currentUser.addresses || []).filter(a => a.id !== id);
                    // Save
                    localStorage.setItem('freshgreens_current_user', JSON.stringify(currentUser));
                    const users = JSON.parse(localStorage.getItem('freshgreens_users')) || [];
                    const idx = users.findIndex(u => u.id === currentUser.id);
                    if (idx !== -1) { users[idx] = currentUser; localStorage.setItem('freshgreens_users', JSON.stringify(users)); }
                    renderAddresses(currentUser);
                });
            });

            const addBtn2 = document.getElementById('addAddressBtn');
            if (addBtn2) addBtn2.addEventListener('click', function() {
                const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                showAddressPrompt(currentUser);
            });
        }

        function showAddressPrompt(user, existing) {
            // Use a simple prompt flow for now
            const label = prompt('Address label (Home, Work, etc):', existing ? existing.label : 'Home');
            if (label === null) return; // cancelled
            const address = prompt('Enter your full address:', existing ? existing.address : '');
            if (address === null) return;

            if (!user.addresses) user.addresses = [];

            if (existing) {
                // update
                user.addresses = user.addresses.map(a => a.id === existing.id ? Object.assign({}, a, { label: label, address: address }) : a);
            } else {
                user.addresses.push({ id: Date.now().toString(), label: label, address: address });
            }

            // Save to localStorage and users list
            localStorage.setItem('freshgreens_current_user', JSON.stringify(user));
            const users = JSON.parse(localStorage.getItem('freshgreens_users')) || [];
            const idx = users.findIndex(u => u.id === user.id);
            if (idx !== -1) { users[idx] = user; } else { users.push(user); }
            localStorage.setItem('freshgreens_users', JSON.stringify(users));

            // Re-render
            renderAddresses(user);
            alert('Address saved');
        }

        // Payment methods: render and CRUD
        function renderPayments(user) {
            const paymentTab = document.getElementById('payment-tab');
            if (!paymentTab) return;

            const payments = (user.paymentMethods && user.paymentMethods.length) ? user.paymentMethods : [];

            if (payments.length === 0) {
                paymentTab.innerHTML = `
                    <div class="section-title">
                        <h2>Payment Methods</h2>
                    </div>
                    <div class="no-orders">
                        <i class="fas fa-credit-card"></i>
                        <h3>No payment methods</h3>
                        <p>You haven't saved any payment methods yet.</p>
                        <button class="btn btn-primary" id="addPaymentBtn">Add Payment Method</button>
                    </div>
                `;
                const addBtn = document.getElementById('addPaymentBtn');
                if (addBtn) addBtn.addEventListener('click', function() {
                    const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                    showPaymentPrompt(currentUser);
                });
                return;
            }

            let html = '<div class="section-title"><h2>Payment Methods</h2></div><div style="display:grid;gap:10px;">';
            payments.forEach(pm => {
                const isDefault = user.defaultPaymentId === pm.id;
                html += `
                    <div class="info-card" style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:600">${pm.label || (pm.type === 'gcash' ? 'GCash' : 'Cash')} ${isDefault ? '· Default' : ''}</div>
                            <div style="color:var(--gray)">${pm.type === 'gcash' ? 'GCash Number: ' + pm.details.number : 'Pay with cash on delivery'}</div>
                        </div>
                        <div style="display:flex;gap:8px">
                            <button class="set-default-payment-btn btn" data-id="${pm.id}">${isDefault ? 'Default' : 'Make Default'}</button>
                            <button class="edit-payment-btn btn" data-id="${pm.id}">Edit</button>
                            <button class="remove-payment-btn btn" data-id="${pm.id}">Remove</button>
                        </div>
                    </div>
                `;
            });
            html += `<div><button class="btn btn-primary" id="addPaymentBtn">Add Payment Method</button></div>`;
            html += '</div>';

            paymentTab.innerHTML = html;

            // Wire buttons
            document.querySelectorAll('.set-default-payment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                    currentUser.defaultPaymentId = id;
                    // Save
                    localStorage.setItem('freshgreens_current_user', JSON.stringify(currentUser));
                    const users = JSON.parse(localStorage.getItem('freshgreens_users')) || [];
                    const idx = users.findIndex(u => u.id === currentUser.id);
                    if (idx !== -1) { users[idx] = currentUser; localStorage.setItem('freshgreens_users', JSON.stringify(users)); }
                    renderPayments(currentUser);
                });
            });

            document.querySelectorAll('.edit-payment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                    const pm = (currentUser.paymentMethods || []).find(p => p.id === id);
                    if (pm) showPaymentPrompt(currentUser, pm);
                });
            });

            document.querySelectorAll('.remove-payment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    if (!confirm('Remove this payment method?')) return;
                    const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                    currentUser.paymentMethods = (currentUser.paymentMethods || []).filter(p => p.id !== id);
                    if (currentUser.defaultPaymentId === id) delete currentUser.defaultPaymentId;
                    // Save
                    localStorage.setItem('freshgreens_current_user', JSON.stringify(currentUser));
                    const users = JSON.parse(localStorage.getItem('freshgreens_users')) || [];
                    const idx = users.findIndex(u => u.id === currentUser.id);
                    if (idx !== -1) { users[idx] = currentUser; localStorage.setItem('freshgreens_users', JSON.stringify(users)); }
                    renderPayments(currentUser);
                });
            });

            const addBtn2 = document.getElementById('addPaymentBtn');
            if (addBtn2) addBtn2.addEventListener('click', function() {
                const currentUser = JSON.parse(localStorage.getItem('freshgreens_current_user'));
                showPaymentPrompt(currentUser);
            });
        }

        function showPaymentPrompt(user, existing) {
            // Prompt user to choose payment type: cash or gcash
            const type = prompt('Enter payment type: "cash" or "gcash"', existing ? existing.type : 'cash');
            if (type === null) return;
            const t = type.trim().toLowerCase();
            if (t !== 'cash' && t !== 'gcash') { alert('Invalid type. Please enter "cash" or "gcash".'); return; }

            if (!user.paymentMethods) user.paymentMethods = [];

            if (t === 'cash') {
                const label = prompt('Label for this payment method (e.g., Cash on Delivery):', existing ? existing.label : 'Cash');
                if (label === null) return;

                if (existing) {
                    user.paymentMethods = user.paymentMethods.map(p => p.id === existing.id ? Object.assign({}, p, { type: 'cash', label: label, details: {} }) : p);
                } else {
                    user.paymentMethods.push({ id: Date.now().toString(), type: 'cash', label: label, details: {} });
                }
            } else {
                // gcash
                const label = prompt('Label for this GCash (e.g., Personal GCash):', existing ? existing.label : 'GCash');
                if (label === null) return;
                const number = prompt('Enter GCash number (digits only):', existing && existing.details ? existing.details.number : '');
                if (number === null) return;

                if (existing) {
                    user.paymentMethods = user.paymentMethods.map(p => p.id === existing.id ? Object.assign({}, p, { type: 'gcash', label: label, details: { number: number } }) : p);
                } else {
                    user.paymentMethods.push({ id: Date.now().toString(), type: 'gcash', label: label, details: { number: number } });
                }
            }

            // Save
            localStorage.setItem('freshgreens_current_user', JSON.stringify(user));
            const users = JSON.parse(localStorage.getItem('freshgreens_users')) || [];
            const idx = users.findIndex(u => u.id === user.id);
            if (idx !== -1) { users[idx] = user; } else { users.push(user); }
            localStorage.setItem('freshgreens_users', JSON.stringify(users));

            renderPayments(user);
            alert('Payment method saved');
        }
    </script>
</body>
</html>